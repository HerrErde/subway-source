name: Update

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - update_event
  #schedule:
  #  - cron: "0 18 * * 4"

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v3

      - name: Set vars
        id: var
        run: |
          echo "orgName=sybo-games" >> $GITHUB_OUTPUT
          echo "appName=subwaysurfers" >> $GITHUB_OUTPUT
          echo "appName2=subway-surfers" >> $GITHUB_OUTPUT
          packageId="com.kiloo.subwaysurf" >> $GITHUB_OUTPUT

          echo version=$(curl -s "https://gplayapi.srik.me/api/apps/$packageId" | jq -r '.version' | tr '.' '-') >> $GITHUB_OUTPUT

      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            ~/.cache/
          key: ${{ runner.os }}-playwright

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.17'

      - name: Install
        run: |
          go install github.com/ericchiang/pup@latest
          pip install pytest-playwright
          playwright install

      - name: Save Cache
        id: cache-save
        uses: actions/cache/save@v3
        with:
          path: |
            ~/.cache/
            ~/pkg/mod/
            ~/usr/lib/python3/
            ~/opt/
          key: ${{ runner.os }}-playwright

      - name: Update Links
        run: python misc/fetch_links.py

      #- name: Get latest Apk
      #  run: python script/down-apk.py ${{steps.var.outputs.orgName}} ${{steps.var.outputs.appName}} ${{steps.var.outputs.appName2}} ${{steps.var.outputs.version}}

      - name: Get latest Apk
        run: |
          chmod +x script/bash/down-apk.sh
          script/bash/down-apk.sh ${{steps.var.outputs.version}}

      - name: Unpack apk
        run: python script/unpack.py ${{steps.var.outputs.version}} ${{steps.var.outputs.appName}}

      - name: Extract Game Data
        run: |
          python script/fetch_characters.py
          python script/fetch_boards.py

      - name: Update Game Data
        run: |
          python misc/sort_characters.py
          python misc/sort_boards.py

      - name: Upload Data
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{steps.var.outputs.version}}
          files: |
            boards_data.json
            boards_sort.json
            characters_data.json
            characters_sort.json

        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
